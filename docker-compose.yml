name: tutorbot-local
version: "3.9"

# =========================
# Redes y volÃºmenes
# =========================
networks:
  app-net:
    driver: bridge

volumes:
  mongo-data:               # modo build/prod
  _docker_data_mongo:       # modo vanilla
  # redis-data:             # si activas redis mÃ¡s adelante

services:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“¦ MongoDB (comÃºn a build y prod) â€” sin auth, volumen "mongo-data"
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  mongo:
    profiles: ["build","prod"]
    image: mongo:6
    container_name: mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks: [app-net]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ“¦ MongoDB (perfil: vanilla) â€” con auth vÃ­a variables de entorno
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctv_mongo:
    profiles: ["vanilla"]
    image: mongo:6.0
    container_name: ctv_mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "27017:27017"
    volumes:
      - _docker_data_mongo:/data/db
    networks: [app-net]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§  Rasa (build/prod) â€” build desde ./rasa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rasa:
    profiles: ["build","prod"]
    build:
      context: ./rasa
      dockerfile: Dockerfile
    container_name: rasa
    restart: unless-stopped
    environment:
      ACTION_SERVER_URL: http://action-server:5055/webhook
      RASA_PORT: "5005"
    ports:
      - "5005:5005"
    depends_on:
      - action-server
    networks: [app-net]
    healthcheck:
      test: ["CMD", "sh", "-lc", "wget -qO- http://127.0.0.1:5005/status | grep -q 'version'"]
      interval: 30s
      timeout: 5s
      retries: 5

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§  Rasa (perfil: vanilla) â€” imagen oficial + monta ./rasa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctv_rasa:
    profiles: ["vanilla"]
    image: rasa/rasa:3.6.19
    container_name: ctv_rasa
    restart: unless-stopped
    command: >
      rasa run
      --enable-api
      --cors "*"
      --port ${RASA_PORT:-5005}
    working_dir: /app/rasa
    volumes:
      - ./rasa:/app/rasa
    ports:
      - "${RASA_PORT:-5005}:5005"
    depends_on:
      - ctv_mongo
    networks: [app-net]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âš™ï¸ Rasa Action Server (build/prod) â€” ./rasa_action_server
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  action-server:
    profiles: ["build","prod"]
    build:
      context: ./rasa_action_server
      dockerfile: Dockerfile
    container_name: action-server
    restart: unless-stopped
    ports:
      - "5055:5055"
    networks: [app-net]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # âš™ï¸ Rasa Action Server (perfil: vanilla) â€” imagen oficial SDK
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ctv_rasa_actions:
    profiles: ["vanilla"]
    image: rasa/rasa-sdk:3.6.2
    container_name: ctv_rasa_actions
    restart: unless-stopped
    working_dir: /app
    command: ["python", "-m", "rasa_sdk", "--actions", "actions"]
    volumes:
      - ./rasa/actions:/app/actions
    ports:
      - "5055:5055"
    depends_on:
      - ctv_rasa
    networks: [app-net]

  # ============================
  # ğŸ Backend DEV (hot reload)
  # ============================
  backend-dev:
    profiles: ["build"]
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: dev               # etapa dev (hot reload)
    container_name: backend-dev
    restart: unless-stopped
    env_file:
      - ./backend/.env          # tu .env local de dev
    environment:
      # Hostnames internos de Docker
      MONGO_URI: mongodb://mongo:27017/chatbot_tutor_virtual_v2
      RASA_URL: http://rasa:5005
      APP_ENV: dev
      DEBUG: "true"
    volumes:
      - ./backend:/app/backend  # monta cÃ³digo para recarga
    depends_on:
      - mongo
      - rasa
    ports:
      - "8000:8000"
    networks: [app-net]
    healthcheck:
      test: ["CMD", "sh", "-lc", "curl -fsS http://127.0.0.1:8000/chat/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  # ======================================
  # ğŸ–¥ï¸ Frontend DEV (Vite con hot reload)
  # ======================================
  admin-dev:
    profiles: ["build"]
    image: node:18-alpine
    container_name: admin-dev
    working_dir: /app
    command: sh -lc "npm ci && npm run dev -- --host --port 5173"
    volumes:
      - ./admin_panel_react:/app
    environment:
      VITE_API_BASE: http://localhost:8000
    ports:
      - "5173:5173"
    depends_on:
      - backend-dev
    networks: [app-net]

  # ============================
  # ğŸ Backend PROD (Uvicorn)
  # ============================
  backend:
    profiles: ["prod"]
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: prod              # etapa prod optimizada
    container_name: backend
    restart: unless-stopped
    env_file:
      - ./backend/.env.production
    environment:
      UVICORN_WORKERS: "2"
      APP_ENV: prod
      DEBUG: "false"
      # Hostnames internos
      MONGO_URI: mongodb://mongo:27017/chatbot_tutor_virtual_v2
      RASA_URL: http://rasa:5005
    depends_on:
      - mongo
      - rasa
    ports:
      - "8000:8000"
    networks: [app-net]
    healthcheck:
      test: ["CMD", "sh", "-lc", "curl -fsS http://127.0.0.1:8000/chat/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  # ==================================
  # ğŸ–¥ï¸ Frontend PROD (Nginx + build)
  # ==================================
  admin:
    profiles: ["prod"]
    build:
      context: ./admin_panel_react
      dockerfile: Dockerfile
    container_name: admin
    restart: unless-stopped
    ports:
      - "8080:80"
    depends_on:
      - backend
    networks: [app-net]

  # =========================================
  # ğŸŒ Nginx Reverse Proxy (solo en prod)
  #   /         â†’ Admin
  #   /api      â†’ FastAPI
  #   /rasa,/ws â†’ Rasa
  # =========================================
  nginx:
    profiles: ["prod"]
    image: nginx:1.27-alpine
    container_name: nginx
    restart: unless-stopped
    depends_on:
      - backend
      - rasa
      - admin
    ports:
      - "80:80"
      # - "443:443"   # si agregas TLS
    volumes:
      - ./ops/nginx/conf.d:/etc/nginx/conf.d:ro
      # - ./ops/nginx/certs:/etc/nginx/certs:ro
    networks: [app-net]

  # =========================================
  # ğŸŒ Nginx Reverse Proxy (solo en build)
  # =========================================
  nginx-dev:
    profiles: ["build"]
    image: nginx:1.27-alpine
    container_name: nginx-dev
    restart: unless-stopped
    depends_on:
      - backend-dev
      - rasa
      - admin-dev
    ports:
      - "80:80"
    volumes:
      - ./ops/nginx/conf.d:/etc/nginx/conf.d:ro
    networks: [app-net]

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # (Opcional) Redis si activas RATE_LIMIT_BACKEND=redis
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # redis:
  #   image: redis:7-alpine
  #   container_name: redis
  #   command: ["redis-server","--appendonly","yes"]
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   networks:
  #     - app-net

  environment:
  ENDPOINTS_TEMPLATE: mongo
  TRACKER_MONGO_URL: mongodb://mongo:27017
  TRACKER_MONGO_DB: rasa
  TRACKER_MONGO_COLLECTION: conversations