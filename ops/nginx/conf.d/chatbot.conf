# Upstreams (nombres = servicios de docker compose)
upstream backend_api  { server backend:8000; }
upstream admin_ui     { server admin:80; }
upstream rasa_server  { server rasa:5005; }

# WebSocket helpers
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name _;

  # Tama√±o para uploads (CSV/JSON intents)
  client_max_body_size 10m;

  # ---------------------------
  # üñ•Ô∏è Admin SPA (React/Nginx)
  # ---------------------------
  location / {
    proxy_pass http://admin_ui;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # CSP del panel (permite embeber el widget y llamar API/Rasa)
    add_header Content-Security-Policy
      "default-src 'self'; \
       frame-ancestors 'self'; \
       img-src 'self' data: blob:; \
       style-src 'self' 'unsafe-inline'; \
       script-src 'self'; \
       connect-src 'self' http://localhost http://backend:8000 http://rasa:5005 ws://rasa:5005;"
      always;

    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  }

  # --------------------------------
  # üêç API FastAPI bajo prefijo /api
  # --------------------------------
  location /api/ {
    # CORS simple (ajusta or√≠genes si usas dominios)
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin      $http_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods     "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers     "Authorization,Content-Type,Accept,Origin,User-Agent" always;
      return 204;
    }
    add_header Access-Control-Allow-Origin      $http_origin always;
    add_header Access-Control-Allow-Credentials "true" always;

    # CSP (API)
    add_header Content-Security-Policy
      "default-src 'none'; \
       frame-ancestors 'self'; \
       connect-src 'self' http://backend:8000 http://rasa:5005; \
       img-src 'self' data: blob:; \
       style-src 'self' 'unsafe-inline'; \
       script-src 'self';"
      always;

    proxy_pass http://backend_api;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
  }

  # ---------------------------------------
  # ü§ñ Rasa REST expuesto bajo /rasa/ (op)
  # ---------------------------------------
  location /rasa/ {
    proxy_pass http://rasa_server/;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
  }

  # -------------------------------------
  # üîå WebSocket directo ‚Üí Rasa /ws
  # -------------------------------------
  location /ws {
    proxy_pass http://rasa_server/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Gzip b√°sico
  gzip on;
  gzip_min_length 1024;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss image/svg+xml;
}