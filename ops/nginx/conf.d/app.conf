# ops/nginx/conf.d/app.conf

# ===== Upstreams (prod + build) =====
# Si estás en PROD: existen "backend" y "admin".
# Si estás en BUILD: existen "backend-dev" y "admin-dev".
upstream backend_up {
  server backend:8000 max_fails=3 fail_timeout=5s;
  server backend-dev:8000 max_fails=3 fail_timeout=5s;
}
upstream admin_up {
  server admin:80 max_fails=3 fail_timeout=5s;
  server admin-dev:5173 max_fails=3 fail_timeout=5s;
}
upstream rasa_up {
  server rasa:5005 max_fails=3 fail_timeout=5s;
}

# ===== Servidor principal =====
server {
  listen 80;
  server_name _;

  # ---- Seguridad básica (ajústalo según tus políticas) ----
  #add_header X-Content-Type-Options nosniff always;
  #add_header X-Frame-Options SAMEORIGIN always;   # Si EMBED por iframe, mejor gestiona con headers de la app
  #add_header Referrer-Policy strict-origin-when-cross-origin always;
  #add_header X-XSS-Protection "1; mode=block" always;

  # ---- Compresión ----
  gzip on;
  gzip_types text/plain text/css application/json application/javascript application/xml+rss application/xml text/javascript image/svg+xml;

  # ---- Tiempo de espera razonable para APIs/chat ----
  proxy_connect_timeout   5s;
  proxy_send_timeout      60s;
  proxy_read_timeout      60s;
  send_timeout            60s;

  # ===========================
  #   /  → Admin (SPA o Vite)
  # ===========================
  location / {
    proxy_pass http://admin_up;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # HMR/WebSocket (Vite en build)
    proxy_http_version 1.1;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        "upgrade";
  }

  # ===========================
  #  /api → FastAPI (backend)
  # ===========================
  location /api/ {
    proxy_pass http://backend_up/;  # OJO: slash final p/ preservar ruta
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Tamaños de carga (si subes audios/archivos)
    client_max_body_size 50m;
    proxy_http_version 1.1;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        "upgrade";
  }

  # ===========================
  #  /rasa → HTTP API Rasa
  # ===========================
  location /rasa/ {
    proxy_pass http://rasa_up/;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 120s;
  }

  # ==================================
  #  /ws → WebSocket directo a Rasa
  # ==================================
  location /ws/ {
    proxy_pass http://rasa_up/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        "upgrade";
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 120s;
  }
}
