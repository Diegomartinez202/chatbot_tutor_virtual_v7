# syntax=docker/dockerfile:1.6
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app/actions

# Dependencias de sistema mínimas (requests/ssl/etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
 && rm -rf /var/lib/apt/lists/*

# 1) Instala rasa-sdk
RUN pip install --upgrade pip && pip install rasa-sdk==3.6.2

# 2) Dependencias opcionales de tus actions (si existe el archivo)
COPY rasa/actions/requirements.txt /tmp/requirements.txt
RUN if [ -f /tmp/requirements.txt ]; then \
      pip install --no-cache-dir -r /tmp/requirements.txt; \
    fi

# 3) Copia sólo el código de acciones
COPY rasa/actions /app/actions

# Usuario no-root
RUN adduser --disabled-password --gecos "" --uid 10002 appuser && \
    chown -R appuser:appuser /app
USER appuser

EXPOSE 5055

# Healthcheck al action server
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD curl -fsS http://localhost:5055/health || exit 1

# Inicia el servidor de acciones
CMD ["python", "-m", "rasa_sdk", "--actions", "actions", "--port", "5055"]